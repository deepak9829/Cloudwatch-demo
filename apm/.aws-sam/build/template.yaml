AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "CloudWatch APM Demo - Distributed Tracing with AWS X-Ray Microservices:\
  \ create-order \u2192 check-inventory + send-notification + DynamoDB\n"
Globals:
  Function:
    Runtime: nodejs20.x
    Timeout: 30
    MemorySize: 256
    Tracing: Active
    Environment:
      Variables:
        TABLE_NAME:
          Ref: OrdersTable
        AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
        NODE_ENV: production
    Tags:
      caylent:owner: deepak.saini@caylent.com
Resources:
  DemoApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      TracingEnabled: true
      Description: CloudWatch APM Demo API
      Cors:
        AllowMethods: '''GET,POST,OPTIONS'''
        AllowHeaders: '''Content-Type,X-Amzn-Trace-Id'''
        AllowOrigin: '''*'''
      Tags:
        caylent:owner: deepak.saini@caylent.com
  OrdersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: cw-apm-demo-orders-${AWS::StackName}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: orderId
        AttributeType: S
      - AttributeName: status
        AttributeType: S
      - AttributeName: createdAt
        AttributeType: S
      KeySchema:
      - AttributeName: orderId
        KeyType: HASH
      GlobalSecondaryIndexes:
      - IndexName: status-createdAt-index
        KeySchema:
        - AttributeName: status
          KeyType: HASH
        - AttributeName: createdAt
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
      - Key: caylent:owner
        Value: deepak.saini@caylent.com
  CreateOrderFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: cw-apm-create-order-${AWS::StackName}
      CodeUri: CreateOrderFunction
      Handler: index.handler
      Description: Receives order requests, orchestrates inventory + notification
      Environment:
        Variables:
          CHECK_INVENTORY_FUNCTION:
            Fn::GetAtt:
            - CheckInventoryFunction
            - Arn
          SEND_NOTIFICATION_FUNCTION:
            Fn::GetAtt:
            - SendNotificationFunction
            - Arn
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: OrdersTable
      - LambdaInvokePolicy:
          FunctionName:
            Ref: CheckInventoryFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: SendNotificationFunction
      Events:
        PostOrder:
          Type: Api
          Properties:
            RestApiId:
              Ref: DemoApi
            Path: /orders
            Method: POST
    Metadata:
      SamResourceId: CreateOrderFunction
  CheckInventoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: cw-apm-check-inventory-${AWS::StackName}
      CodeUri: CheckInventoryFunction
      Handler: index.handler
      Description: Simulates inventory lookup with variable latency per product type
      Timeout: 15
    Metadata:
      SamResourceId: CheckInventoryFunction
  SendNotificationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: cw-apm-send-notification-${AWS::StackName}
      CodeUri: SendNotificationFunction
      Handler: index.handler
      Description: Simulates sending order confirmation (email/SMS) with occasional
        faults
      Timeout: 10
    Metadata:
      SamResourceId: SendNotificationFunction
  GetOrdersFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: cw-apm-get-orders-${AWS::StackName}
      CodeUri: GetOrdersFunction
      Handler: index.handler
      Description: Queries orders from DynamoDB with optional status filter
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: OrdersTable
      Events:
        GetOrders:
          Type: Api
          Properties:
            RestApiId:
              Ref: DemoApi
            Path: /orders
            Method: GET
        GetOrderById:
          Type: Api
          Properties:
            RestApiId:
              Ref: DemoApi
            Path: /orders/{orderId}
            Method: GET
    Metadata:
      SamResourceId: GetOrdersFunction
  HealthCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: cw-apm-health-${AWS::StackName}
      CodeUri: HealthCheckFunction
      Handler: index.handler
      Description: Health check endpoint to verify API availability
      Events:
        Health:
          Type: Api
          Properties:
            RestApiId:
              Ref: DemoApi
            Path: /health
            Method: GET
    Metadata:
      SamResourceId: HealthCheckFunction
  ApplicationInsightsApp:
    Type: AWS::ApplicationInsights::Application
    Properties:
      ResourceGroupName:
        Fn::Sub: cw-apm-demo-${AWS::StackName}
      AutoConfigurationEnabled: true
      CWEMonitorEnabled: true
      OpsCenterEnabled: false
      Tags:
      - Key: caylent:owner
        Value: deepak.saini@caylent.com
  ApplicationResourceGroup:
    Type: AWS::ResourceGroups::Group
    Properties:
      Name:
        Fn::Sub: cw-apm-demo-${AWS::StackName}
      ResourceQuery:
        Type: CLOUDFORMATION_STACK_1_0
      Tags:
      - Key: caylent:owner
        Value: deepak.saini@caylent.com
  MonitoringDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName:
        Fn::Sub: CloudWatch-APM-Demo-${AWS::StackName}
      DashboardBody:
        Fn::Sub: "{\n  \"widgets\": [\n    {\n      \"type\": \"metric\",\n      \"\
          properties\": {\n        \"title\": \"Lambda Invocations & Errors\",\n \
          \       \"region\": \"${AWS::Region}\",\n        \"metrics\": [\n      \
          \    [\"AWS/Lambda\", \"Invocations\", \"FunctionName\", \"${CreateOrderFunction}\"\
          , {\"stat\": \"Sum\", \"period\": 60}],\n          [\"AWS/Lambda\", \"Errors\"\
          ,      \"FunctionName\", \"${CreateOrderFunction}\", {\"stat\": \"Sum\"\
          , \"period\": 60, \"color\": \"#d62728\"}],\n          [\"AWS/Lambda\",\
          \ \"Invocations\", \"FunctionName\", \"${CheckInventoryFunction}\", {\"\
          stat\": \"Sum\", \"period\": 60}],\n          [\"AWS/Lambda\", \"Invocations\"\
          , \"FunctionName\", \"${SendNotificationFunction}\", {\"stat\": \"Sum\"\
          , \"period\": 60}]\n        ],\n        \"view\": \"timeSeries\",\n    \
          \    \"period\": 60\n      }\n    },\n    {\n      \"type\": \"metric\"\
          ,\n      \"properties\": {\n        \"title\": \"Lambda Duration (P50/P99)\"\
          ,\n        \"region\": \"${AWS::Region}\",\n        \"metrics\": [\n   \
          \       [\"AWS/Lambda\", \"Duration\", \"FunctionName\", \"${CreateOrderFunction}\"\
          , {\"stat\": \"p50\"}],\n          [\"AWS/Lambda\", \"Duration\", \"FunctionName\"\
          , \"${CreateOrderFunction}\", {\"stat\": \"p99\", \"color\": \"#ff7f0e\"\
          }],\n          [\"AWS/Lambda\", \"Duration\", \"FunctionName\", \"${CheckInventoryFunction}\"\
          , {\"stat\": \"p99\"}],\n          [\"AWS/Lambda\", \"Duration\", \"FunctionName\"\
          , \"${SendNotificationFunction}\", {\"stat\": \"p99\"}]\n        ],\n  \
          \      \"view\": \"timeSeries\",\n        \"period\": 60\n      }\n    },\n\
          \    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"\
          title\": \"API Gateway Latency & 4xx/5xx\",\n        \"region\": \"${AWS::Region}\"\
          ,\n        \"metrics\": [\n          [\"AWS/ApiGateway\", \"Latency\", \
          \ \"ApiName\", \"DemoApi\", {\"stat\": \"p99\"}],\n          [\"AWS/ApiGateway\"\
          , \"4XXError\",  \"ApiName\", \"DemoApi\", {\"stat\": \"Sum\", \"color\"\
          : \"#ff7f0e\"}],\n          [\"AWS/ApiGateway\", \"5XXError\",  \"ApiName\"\
          , \"DemoApi\", {\"stat\": \"Sum\", \"color\": \"#d62728\"}]\n        ],\n\
          \        \"view\": \"timeSeries\",\n        \"period\": 60\n      }\n  \
          \  },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n   \
          \     \"title\": \"DynamoDB Read/Write Units\",\n        \"region\": \"\
          ${AWS::Region}\",\n        \"metrics\": [\n          [\"AWS/DynamoDB\",\
          \ \"ConsumedReadCapacityUnits\",  \"TableName\", \"${OrdersTable}\", {\"\
          stat\": \"Sum\"}],\n          [\"AWS/DynamoDB\", \"ConsumedWriteCapacityUnits\"\
          , \"TableName\", \"${OrdersTable}\", {\"stat\": \"Sum\"}]\n        ],\n\
          \        \"view\": \"timeSeries\",\n        \"period\": 60\n      }\n  \
          \  }\n  ]\n}\n"
Outputs:
  ApiUrl:
    Description: Base URL for the demo API
    Value:
      Fn::Sub: https://${DemoApi}.execute-api.${AWS::Region}.amazonaws.com/prod
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ApiUrl
  OrdersTableName:
    Description: DynamoDB orders table name
    Value:
      Ref: OrdersTable
  XRayConsoleUrl:
    Description: AWS X-Ray Service Map console link
    Value:
      Fn::Sub: https://${AWS::Region}.console.aws.amazon.com/xray/home?region=${AWS::Region}#/service-map
  CloudWatchDashboardUrl:
    Description: CloudWatch Dashboard URL
    Value:
      Fn::Sub: https://${AWS::Region}.console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=CloudWatch-APM-Demo-${AWS::StackName}
